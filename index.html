import React, { useState, useEffect } from 'react';
import { initializeApp } from 'firebase/app';
import { 
  getAuth, 
  signInWithPopup, 
  FacebookAuthProvider, 
  onAuthStateChanged, 
  signInAnonymously, 
  signInWithCustomToken,
  signOut 
} from 'firebase/auth';
import { 
  getFirestore, 
  collection, 
  doc, 
  setDoc, 
  serverTimestamp 
} from 'firebase/firestore';
import { 
  Facebook, 
  Smartphone, 
  Laptop, 
  Users, 
  TowerControl as Tower, 
  Mail, 
  CheckCircle2, 
  ArrowRight,
  Menu,
  X,
  LogOut,
  Baby
} from 'lucide-react';

// --- CONFIGURACIÓN DE FIREBASE ---
const firebaseConfig = JSON.parse(__firebase_config);
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const appId = typeof __app_id !== 'undefined' ? __app_id : 'chambamax-v1';

export default function App() {
  const [user, setUser] = useState(null);
  const [isMenuOpen, setIsMenuOpen] = useState(false);
  const [loading, setLoading] = useState(true);
  const [submitted, setSubmitted] = useState(false);
  const [formData, setFormData] = useState({
    nombre: '',
    whatsapp: '',
    perfil: 'digital',
    estatus: 'regular',
    mensaje: ''
  });

  // --- REGLA 3: AUTENTICACIÓN ---
  useEffect(() => {
    const initAuth = async () => {
      try {
        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
          await signInWithCustomToken(auth, __initial_auth_token);
        }
      } catch (err) {
        console.error("Auth Error:", err);
      }
    };
    initAuth();

    const unsubscribe = onAuthStateChanged(auth, (currentUser) => {
      setUser(currentUser);
      if (currentUser && !formData.nombre) {
        setFormData(prev => ({ ...prev, nombre: currentUser.displayName || '' }));
      }
      setLoading(false);
    });

    return () => unsubscribe();
  }, []);

  const loginWithFacebook = async () => {
    const provider = new FacebookAuthProvider();
    try {
      await signInWithPopup(auth, provider);
    } catch (error) {
      console.error("Facebook Login Error:", error);
    }
  };

  const handleLogout = () => signOut(auth);

  const handleSubmit = async (e) => {
    e.preventDefault();
    
    // Asegurar que hay un usuario (Anónimo si no es Facebook)
    let currentUser = auth.currentUser;
    if (!currentUser) {
      try {
        const cred = await signInAnonymously(auth);
        currentUser = cred.user;
      } catch (err) {
        console.error("Anonymous sign in failed", err);
        return;
      }
    }

    try {
      // REGLA 1: Path estricto para datos de usuario
      const userRef = doc(db, 'artifacts', appId, 'users', currentUser.uid, 'postulaciones', 'data');
      await setDoc(userRef, {
        ...formData,
        userId: currentUser.uid,
        email: currentUser.email || 'n/a',
        photo: currentUser.photoURL || '',
        isFacebook: !currentUser.isAnonymous,
        createdAt: serverTimestamp()
      });
      setSubmitted(true);
      setFormData({ nombre: '', whatsapp: '', perfil: 'digital', estatus: 'regular', mensaje: '' });
      setTimeout(() => setSubmitted(false), 5000);
    } catch (error) {
      console.error("Firestore Error:", error);
    }
  };

  const NavLink = ({ href, children, onClick }) => (
    <a 
      href={href} 
      onClick={onClick}
      className="text-sm font-bold uppercase tracking-widest hover:text-cyan-500 transition-colors"
    >
      {children}
    </a>
  );

  return (
    <div className="min-h-screen bg-slate-50 text-slate-900 selection:bg-cyan-100">
      {/* Header */}
      <nav className="fixed top-0 w-full z-50 bg-white/80 backdrop-blur-md border-b border-slate-200">
        <div className="max-w-7xl mx-auto px-4 h-20 flex items-center justify-between">
          <div className="flex items-center gap-2">
            <div className="w-10 h-10 bg-slate-900 rounded-xl flex items-center justify-center text-white font-black italic">CM</div>
            <span className="font-black text-2xl tracking-tighter italic uppercase">CHAMBAMAX<span className="text-cyan-500">®</span></span>
          </div>

          {/* Desktop Nav */}
          <div className="hidden md:flex items-center gap-8">
            <NavLink href="#digital">Home Office</NavLink>
            <NavLink href="#tecnico">Técnicos</NavLink>
            <NavLink href="#empresas">Empresarios</NavLink>
            {user ? (
              <div className="flex items-center gap-4 pl-4 border-l border-slate-200">
                {user.photoURL && <img src={user.photoURL} className="w-8 h-8 rounded-full border border-cyan-500" alt="Avatar" />}
                <button onClick={handleLogout} className="p-2 hover:bg-slate-100 rounded-lg text-slate-400"><LogOut size={18} /></button>
              </div>
            ) : (
              <button 
                onClick={loginWithFacebook}
                className="flex items-center gap-2 bg-[#1877F2] text-white px-5 py-2.5 rounded-xl font-bold text-sm shadow-lg hover:bg-[#145dbf] transition-all"
              >
                <Facebook size={18} fill="currentColor" /> Vincular Facebook
              </button>
            )}
          </div>

          {/* Mobile Menu Toggle */}
          <button className="md:hidden p-2" onClick={() => setIsMenuOpen(!isMenuOpen)}>
            {isMenuOpen ? <X size={24} /> : <Menu size={24} />}
          </button>
        </div>

        {/* Mobile Nav */}
        {isMenuOpen && (
          <div className="md:hidden bg-white border-b border-slate-200 p-6 space-y-4 flex flex-col items-center animate-in slide-in-from-top duration-300">
            <NavLink href="#digital" onClick={() => setIsMenuOpen(false)}>Home Office</NavLink>
            <NavLink href="#tecnico" onClick={() => setIsMenuOpen(false)}>Técnicos</NavLink>
            <NavLink href="#empresas" onClick={() => setIsMenuOpen(false)}>Empresarios</NavLink>
            {!user && (
              <button onClick={loginWithFacebook} className="w-full flex items-center justify-center gap-2 bg-[#1877F2] text-white py-4 rounded-2xl font-bold">
                <Facebook size={20} fill="currentColor" /> Conectar Facebook
              </button>
            )}
          </div>
        )}
      </nav>

      {/* Hero Section */}
      <section className="pt-32 pb-20 px-4">
        <div className="max-w-6xl mx-auto text-center">
          <div className="inline-flex items-center gap-2 bg-slate-900 text-white text-[10px] font-black tracking-[0.3em] uppercase px-4 py-2 rounded-full mb-8">
            <span className="w-2 h-2 bg-cyan-500 rounded-full animate-pulse"></span>
            Oportunidad Real • Sin Títulos • Con Actitud
          </div>
          <h1 className="text-6xl md:text-9xl font-black tracking-tighter italic uppercase leading-[0.85] mb-8">
            EL MEDIO ENTRE <br /> TU TALENTO <span className="text-cyan-500">Y LA CHAMBA</span>
          </h1>
          <p className="text-xl text-slate-500 max-w-2xl mx-auto mb-12 font-medium">
            ChambaMax® y CiBERALL® se unen para conectar a personas con actitud con las mejores plataformas digitales y servicios de internet.
          </p>
          <div className="flex flex-col sm:flex-row justify-center gap-4">
            <a href="#club" className="bg-slate-900 text-white px-10 py-5 rounded-3xl font-black uppercase tracking-widest text-sm hover:scale-105 transition-transform shadow-2xl">Postularme Ahora</a>
            <a href="#digital" className="bg-white border-2 border-slate-200 px-10 py-5 rounded-3xl font-black uppercase tracking-widest text-sm hover:bg-slate-50 transition-colors">Ver Vacantes</a>
          </div>
        </div>
      </section>

      {/* Digital Sales (Home Office) */}
      <section id="digital" className="py-24 bg-white overflow-hidden">
        <div className="max-w-7xl mx-auto px-4 grid lg:grid-cols-2 gap-16 items-center">
          <div className="relative">
            <div className="absolute -top-10 -left-10 w-64 h-64 bg-cyan-100 rounded-full blur-3xl opacity-50"></div>
            <img 
              src="https://images.unsplash.com/photo-1590650153855-d9e808231d41?auto=format&fit=crop&q=80&w=800" 
              className="relative z-10 rounded-[3rem] shadow-2xl grayscale hover:grayscale-0 transition-all duration-700 aspect-square object-cover" 
              alt="Home Office" 
            />
            <div className="absolute -bottom-8 -right-8 bg-white p-8 rounded-[2.5rem] shadow-2xl z-20 border border-slate-100">
              <div className="flex items-center gap-4">
                <div className="bg-cyan-500 p-3 rounded-2xl text-white"><Baby size={32} /></div>
                <div>
                  <p className="font-black text-2xl italic leading-none">NO DESCUIDES</p>
                  <p className="text-slate-500 font-bold text-xs uppercase tracking-widest">A TUS HIJOS</p>
                </div>
              </div>
            </div>
          </div>
          <div>
            <span className="text-cyan-500 font-black uppercase tracking-[0.4em] text-xs">Ventas Digitales</span>
            <h2 className="text-5xl md:text-7xl font-black italic uppercase leading-none mt-4 mb-8">
              TRABAJA DESDE TU <span className="text-slate-400">SMARTPHONE</span>
            </h2>
            <p className="text-lg text-slate-600 mb-10 leading-relaxed">
              ¿Tienes una laptop o un celular en casa? Conviértete en distribuidor de servicios de internet y plataformas digitales. Tú manejas tu tiempo, tú eres tu propio jefe.
            </p>
            <div className="grid grid-cols-1 md:grid-cols-2 gap-6 mb-12">
              {[
                { icon: <Smartphone size={20} />, text: "Solo necesitas Celular" },
                { icon: <Laptop size={20} />, text: "O una Laptop" },
                { icon: <Users size={20} />, text: "Para padres y madres" },
                { icon: <CheckCircle2 size={20} />, text: "Capacitación incluida" }
              ].map((item, i) => (
                <div key={i} className="flex items-center gap-4 bg-slate-50 p-4 rounded-2xl border border-slate-100 font-bold text-sm uppercase italic">
                  <span className="text-cyan-500">{item.icon}</span>
                  {item.text}
                </div>
              ))}
            </div>
            <a href="#club" className="inline-flex items-center gap-3 bg-cyan-500 text-white px-8 py-4 rounded-2xl font-black uppercase tracking-widest text-sm hover:bg-slate-900 transition-colors">
              Empezar ahora <ArrowRight size={18} />
            </a>
          </div>
        </div>
      </section>

      {/* Tech Section */}
      <section id="tecnico" className="py-24 bg-slate-900 text-white relative">
        <div className="absolute inset-0 opacity-10 pointer-events-none" style={{ backgroundImage: 'radial-gradient(#00aeef 1px, transparent 1px)', backgroundSize: '30px 30px' }}></div>
        <div className="max-w-7xl mx-auto px-4 text-center relative z-10">
          <h2 className="text-5xl md:text-8xl font-black italic uppercase leading-none mb-6">¿SABES <span className="text-cyan-500">JALAR CABLES</span>?</h2>
          <p className="text-xl text-slate-400 max-w-3xl mx-auto mb-20 font-medium">
            Buscamos técnicos instaladores de Antenas Satelitales, Redes de Datos y Fibra Óptica para proyectos activos con CiBERALL®.
          </p>
          
          <div className="grid md:grid-cols-3 gap-8">
            {[
              { icon: <Tower size={40} />, title: "Antenas", desc: "Instalación y alineación satelital en zonas rurales." },
              { icon: <Laptop size={40} />, title: "Redes", desc: "Configuración de módems, routers y repetidores." },
              { icon: <CheckCircle2 size={40} />, title: "Mantenimiento", desc: "Soporte técnico directo a clientes finales." }
            ].map((card, i) => (
              <div key={i} className="bg-white/5 border border-white/10 p-10 rounded-[3rem] hover:bg-white/10 transition-colors text-left group">
                <div className="text-cyan-500 mb-6 group-hover:scale-110 transition-transform duration-500">{card.icon}</div>
                <h3 className="text-2xl font-black italic uppercase mb-2">{card.title}</h3>
                <p className="text-slate-500 font-medium">{card.desc}</p>
              </div>
            ))}
          </div>
          
          <div className="mt-20">
            <a href="https://ciberall.net/contacto.htm" target="_blank" className="bg-white text-slate-900 px-12 py-6 rounded-3xl font-black uppercase tracking-widest italic hover:bg-cyan-500 hover:text-white transition-all shadow-2xl">
              Ir a CiBERALL.NET
            </a>
          </div>
        </div>
      </section>

      {/* Entrepreneurs Section */}
      <section id="empresas" className="py-24 bg-amber-500 text-white overflow-hidden">
        <div className="max-w-6xl mx-auto px-4 text-center">
          <h2 className="text-5xl md:text-7xl font-black italic uppercase leading-none mb-8">¿ERES EMPRESARIO Y BUSCAS <span className="text-slate-900 underline decoration-white">TALENTO</span>?</h2>
          <p className="text-2xl font-bold mb-16 opacity-90 max-w-3xl mx-auto">
            Aquí sobra el talento y la actitud. Conectamos tu empresa con personas dispuestas a crecer.
          </p>
          
          <div className="bg-slate-900 p-10 md:p-16 rounded-[4rem] shadow-2xl inline-block w-full max-w-4xl text-left relative">
            <div className="absolute top-0 right-0 w-32 h-32 bg-amber-400/20 rounded-full blur-3xl"></div>
            <div className="grid md:grid-cols-2 gap-10 items-center">
              <div>
                <h3 className="text-3xl font-black italic uppercase mb-4">Enlace Directo</h3>
                <p className="text-slate-400 font-medium mb-6">Manda un mensaje personal a nuestro coordinador y con gusto te enlazamos con los perfiles adecuados para tu negocio.</p>
                <a href="mailto:fernando@lonso.net" className="inline-flex items-center gap-3 bg-amber-500 text-white px-8 py-4 rounded-2xl font-black uppercase tracking-widest text-sm hover:scale-105 transition-transform">
                  fernando@lonso.net <Mail size={18} />
                </a>
              </div>
              <div className="hidden md:block">
                <div className="space-y-4">
                  {[1, 2, 3].map(i => (
                    <div key={i} className="flex gap-4 items-center bg-white/5 p-4 rounded-2xl border border-white/10 animate-pulse">
                      <div className="w-10 h-10 bg-slate-800 rounded-full"></div>
                      <div className="space-y-2">
                        <div className="w-32 h-2 bg-slate-800 rounded"></div>
                        <div className="w-20 h-2 bg-slate-800 rounded"></div>
                      </div>
                    </div>
                  ))}
                </div>
              </div>
            </div>
          </div>
        </div>
      </section>

      {/* Form Section */}
      <section id="club" className="py-24 bg-white relative">
        <div className="max-w-4xl mx-auto px-4">
          <div className="text-center mb-16">
            <h2 className="text-5xl md:text-7xl font-black italic uppercase leading-none">ÚNETE AL <span className="text-cyan-500">CLUB CHAMBAMAX</span></h2>
            <p className="text-slate-500 font-black uppercase text-[10px] tracking-[0.4em] mt-4">Registro rápido vinculado con tu red social</p>
          </div>

          <div className="bg-slate-50 border border-slate-100 p-8 md:p-16 rounded-[3.5rem] shadow-2xl relative overflow-hidden">
            {submitted ? (
              <div className="text-center py-10 animate-in fade-in zoom-in duration-500">
                <div className="w-20 h-20 bg-green-100 text-green-600 rounded-full flex items-center justify-center mx-auto mb-6">
                  <CheckCircle2 size={40} />
                </div>
                <h3 className="text-4xl font-black italic uppercase mb-2">¡Datos Recibidos!</h3>
                <p className="text-slate-500 font-medium">Un agente de ChambaMax te contactará por WhatsApp muy pronto.</p>
              </div>
            ) : (
              <form onSubmit={handleSubmit} className="space-y-8 relative z-10">
                {/* Facebook Quick Connect */}
                {!user ? (
                  <button 
                    type="button"
                    onClick={loginWithFacebook}
                    className="w-full flex items-center justify-center gap-4 bg-[#1877F2] text-white py-5 rounded-3xl font-black uppercase tracking-widest text-xs hover:shadow-xl transition-all shadow-blue-100"
                  >
                    <Facebook size={20} fill="currentColor" /> Vincular con mi Facebook
                  </button>
                ) : (
                  <div className="flex items-center gap-4 bg-white p-4 rounded-3xl border border-slate-200">
                    <img src={user.photoURL} className="w-12 h-12 rounded-full border-2 border-cyan-500" alt="FB User" />
                    <div>
                      <p className="text-[10px] font-black text-slate-400 uppercase tracking-widest">Conectado como</p>
                      <p className="font-black italic uppercase">{user.displayName}</p>
                    </div>
                  </div>
                )}

                <div className="grid md:grid-cols-2 gap-8">
                  <div className="md:col-span-2">
                    <label className="text-[10px] font-black uppercase tracking-[0.2em] text-slate-400 ml-4 mb-2 block">Tu Nombre Completo</label>
                    <input 
                      type="text" 
                      required
                      value={formData.nombre}
                      onChange={e => setFormData({...formData, nombre: e.target.value})}
                      className="w-full bg-white border-none p-5 rounded-3xl font-bold italic focus:ring-2 focus:ring-cyan-500 shadow-sm"
                      placeholder="Ej. Maria Garcia"
                    />
                  </div>
                  <div>
                    <label className="text-[10px] font-black uppercase tracking-[0.2em] text-slate-400 ml-4 mb-2 block">WhatsApp de Contacto</label>
                    <input 
                      type="tel" 
                      required
                      value={formData.whatsapp}
                      onChange={e => setFormData({...formData, whatsapp: e.target.value})}
                      className="w-full bg-white border-none p-5 rounded-3xl font-bold italic focus:ring-2 focus:ring-cyan-500 shadow-sm"
                      placeholder="+52 ..."
                    />
                  </div>
                  <div>
                    <label className="text-[10px] font-black uppercase tracking-[0.2em] text-slate-400 ml-4 mb-2 block">Perfil de interés</label>
                    <select 
                      value={formData.perfil}
                      onChange={e => setFormData({...formData, perfil: e.target.value})}
                      className="w-full bg-white border-none p-5 rounded-3xl font-bold italic focus:ring-2 focus:ring-cyan-500 shadow-sm appearance-none"
                    >
                      <option value="digital">Ventas Digitales (Desde Casa)</option>
                      <option value="tecnico">Técnico Instalador (Campo)</option>
                      <option value="otro">Otro Oficio / Actitud</option>
                    </select>
                  </div>
                </div>

                <button 
                  type="submit" 
                  className="w-full bg-slate-900 text-white py-6 rounded-[2rem] font-black uppercase tracking-widest text-sm hover:bg-cyan-500 transition-all shadow-2xl"
                >
                  Postular mi Actitud Ahora
                </button>
              </form>
            )}
            
            {/* Background Accent */}
            <div className="absolute -bottom-20 -right-20 w-64 h-64 bg-cyan-500/5 rounded-full blur-3xl"></div>
          </div>
        </div>
      </section>

      {/* Footer */}
      <footer className="bg-slate-900 text-white py-20 border-t border-white/5">
        <div className="max-w-7xl mx-auto px-4">
          <div className="grid md:grid-cols-3 gap-16 items-center">
            <div className="text-center md:text-left">
              <div className="flex items-center gap-2 mb-6 justify-center md:justify-start">
                <div className="w-8 h-8 bg-white text-slate-900 rounded-lg flex items-center justify-center font-black italic">CM</div>
                <span className="font-black text-xl italic uppercase">CHAMBAMAX<span className="text-cyan-500">®</span></span>
              </div>
              <p className="text-[10px] text-slate-500 font-black uppercase tracking-[0.3em] leading-relaxed">
                Una iniciativa de CiBERALL® Global <br /> Trabajo digno sin intermediarios.
              </p>
            </div>
            <div className="flex flex-col items-center gap-6">
              <span className="text-[10px] font-black uppercase tracking-[0.4em] text-cyan-500">Comunidad Oficial</span>
              <div className="flex gap-8">
                <a href="https://www.facebook.com/portal.chambamax/" target="_blank" className="text-2xl hover:text-cyan-500 transition-colors"><Facebook fill="currentColor" /></a>
                <a href="https://www.tiktok.com/@chambamax" target="_blank" className="text-2xl hover:text-cyan-500 transition-colors">
                  <svg className="w-6 h-6" fill="currentColor" viewBox="0 0 24 24"><path d="M12.525.02c1.31-.02 2.61-.01 3.91-.02.08 1.53.63 3.09 1.75 4.17 1.12 1.11 2.7 1.62 4.24 1.79v4.03c-1.44-.05-2.89-.35-4.2-.97-.57-.26-1.1-.59-1.62-.93-.01 2.92.01 5.84-.02 8.75-.03 1.4-.54 2.79-1.35 3.94-1.31 1.92-3.58 3.17-5.91 3.21-1.43.08-2.86-.31-4.08-1.03-2.02-1.19-3.44-3.37-3.65-5.71-.02-.5-.03-1-.01-1.49.18-1.9 1.12-3.72 2.58-4.96 1.66-1.44 3.98-2.13 6.15-1.72.02 1.48-.04 2.96-.04 4.44-.99-.32-2.15-.23-3.02.37-.63.41-1.11 1.04-1.36 1.75-.21.51-.15 1.07-.14 1.61.24 1.64 1.82 3.02 3.5 2.87 1.12-.01 2.19-.66 2.77-1.61.19-.33.4-.67.41-1.06.1-1.79.06-3.57.07-5.36.01-4.03-.01-8.05.02-12.07z"/></svg>
                </a>
              </div>
            </div>
            <div className="text-center md:text-right">
              <span className="text-[10px] text-slate-500 uppercase tracking-widest mb-2 block">Canal Empresarial</span>
              <a href="mailto:fernando@lonso.net" className="text-lg font-black italic hover:text-amber-500 transition-colors uppercase underline decoration-cyan-500">fernando@lonso.net</a>
            </div>
          </div>
          <div className="mt-20 pt-8 border-t border-white/5 text-center">
            <p className="text-[8px] text-slate-700 uppercase tracking-[0.8em]">© 2026 CHAMBAMAX® • TODOS LOS DERECHOS RESERVADOS • CiBERALL® GLOBAL SOLUTIONS</p>
          </div>
        </div>
      </footer>
    </div>
  );
}
